<!doctype html>

<html lang="en" ng-app="emrctrl">
  <head>
    <meta charset="utf-8">
    <title>EMRCRTL</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQEAYAAABPYyMiAAAABmJLR0T///////8JWPfcAAAACXBIWXMAAABIAAAASABGyWs+AAAAF0lEQVRIx2NgGAWjYBSMglEwCkbBSAcACBAAAeaR9cIAAAAASUVORK5CYII=">
    <link rel="stylesheet" href="styles/bootstrap.min.css">
    <link rel="stylesheet" href="styles/font-awesome.css">
    <link rel="stylesheet" href="styles/app.css">
    <script src="lib/jquery.min.js"></script>
    <!-- <script src="lib/bootstrap.min.js"></script> -->
    <script src="lib/underscore.min.js"></script>
    <script src="lib/underscore.string.min.js"></script>
    <script src="lib/moment.min.js"></script>
    <script src="lib/angular.min.js"></script>
    <script src="app/main.js"></script>
  </head>
  <body>
    <div class="container" ng-controller="AppController">
      <div class="row">
        <div class="span12">
          <div class="navbar">
            <div class="navbar-inner">
              <a class="brand" href="#">
                <i class="icon-cogs"></i>
                EMRCTRL
              </a>
              <ul class="nav pull-right">
                <li>
                  <a ng-click="reload()" ng-hide="loading">
                    <i class="icon-refresh"></i>
                    Reload
                  </a>
                  <a ng-show="loading">
                    <i class="icon-cog"></i>
                    Loading...
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div ng-show="selectedFlow">
        <div class="row">
          <div class="span2">
            <ng-include src="'flow-details'"></ng-include>
          </div>
          <div class="span5">
            <ng-include src="'flow-steps'"></ng-include>
          </div>
          <div class="span5">
            <ng-include src="'flow-instance-groups'"></ng-include>
          </div>
        </div>
        <div class="row" ng-show="logUrl">
          <div class="span12">
            <iframe src="{{logUrl}}" width="100%" height="200"></iframe>
          </div>
        </div>
      </div>

      <hr ng-show="selectedFlow">

      <div class="row" ng-show="flows.length > 0">
        <div class="span12">
          <div>
            <table class="flows table table-striped table-hover table-condensed">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Created at</th>
                  <th>Ended at</th>
                  <th>Elapsed time</th>
                  <th>State</th>
                </tr>
              </thead>
              <tbody>
                <tr ng-repeat="flow in flows" ng-click="selectFlow(flow)" ng-class="{selected: flow == selectedFlow}">
                  <td class="job-flow-id">{{flow.job_flow_id}}</td>
                  <td class="job-flow-name">{{flow.name}}</td>
                  <td title="{{flow.created_at | isoDateTime}}">{{flow.created_at | timeAgo}}</td>
                  <td title="{{flow.ended_at | isoDateTime}}">
                    <span ng-show="flow.ended_at">
                      {{flow.ended_at | timeAgo}}
                    </span>
                    <span ng-hide="flow.ended_at">
                      -
                    </span>
                  </td>
                  <td>{{flow.elapsed_time | elapsedTime}}</td>
                  <td title="{{flow.last_state_change_reason}}">
                    <!-- TODO: make a directive and reuse in flow step details -->
                    <span ng-class="{
                      'badge': true,
                      'badge-success': flow.state == 'COMPLETED',
                      'badge-warning': flow.state == 'TERMINATED',
                      'badge-important': flow.state == 'FAILED',
                      'badge-info': flow.state == 'RUNNING',
                      'badge-inverse': false
                    }">
                      <i ng-class="{
                        'flow-state-icon': true,
                        'icon-cog': flow.state == 'STARTING',
                        'icon-cogs': flow.state == 'BOOTSTRAPPING',
                        'icon-time': flow.state == 'RUNNING',
                        'icon-ok-sign': flow.state == 'COMPLETED',
                        'icon-exclamation-sign': flow.state == 'TERMINATED',
                        'icon-warning-sign': flow.state == 'FAILED',
                        'icon-off': flow.state == 'SHUTTING_DOWN'
                      }"></i>&nbsp;{{flow.state}}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script type="text/ng-template" id="flow-details">
      <h4>Details</h4>
      <p>
        {{selectedFlow.last_state_change_reason}}
      </p>
      <p ng-show="selectedFlow.master_public_dns_name && selectedFlow.state == 'RUNNING'">
        <a href="http://{{selectedFlow.master_public_dns_name}}:9100/" target="_blank">
          jobtracker
          <i class="icon-external-link"></i>
        </a>
      </p>
    </script>

    <script type="text/ng-template" id="flow-steps">
      <div class="steps">
        <h4>Steps</h4>
        <table class="table table-striped table-hover table-condensed">
          <tbody>
            <tr ng-repeat="step in selectedFlow.step_details">
              <td>{{step.step_config.name}}</td>
              <td>{{step.execution_status_detail.state}}</td>
              <td>
                <select class="log-name" ng-model="logName" ng-change="viewLog(step, logName); logName = ''">
                  <option value="">View logs</option>
                  <option>controller</option>
                  <option>stderr</option>
                  <option>stdout</option>
                  <option>syslog</option>
                </select>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </script>

    <script type="text/ng-template" id="flow-instance-groups">
      <h4>Instance groups</h4>
      <table class="table table-striped table-hover table-condensed">
        <tbody>
          <tr ng-repeat="group in selectedFlow.instance_group_details">
            <td>{{group.name}}</td>
            <td>
              {{group.instance_type}}
              <span ng-show="group.market == 'SPOT'">(spot)</span>
            </td>
            <td>{{group.state}}</td>
            <td>{{group.instance_running_count}} of {{group.instance_request_count}} running</td>
          </tr>
        </tbody>
      </table>
    </script>
  </body>
</html>